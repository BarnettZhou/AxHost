<!-- 全局 JavaScript 脚本组件 -->
<script>
    // 全局当前用户信息
    let currentUser = null;
    
    // 初始化获取当前用户信息
    async function init() {
        try {
            const response = await fetch('/api/auth/me');
            if (!response.ok) {
                window.location.href = '/login';
                return;
            }
            currentUser = await response.json();
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            
            // 显示管理入口（管理员）
            if (currentUser.role === 'admin') {
                const navbarAdminLink = document.getElementById('navbarAdminLink');
                if (navbarAdminLink) navbarAdminLink.classList.remove('hidden');
            }
            
            // 显示上传按钮（管理员和产品经理）
            if (['admin', 'product_manager'].includes(currentUser.role)) {
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) uploadBtn.classList.remove('hidden');
            }
        } catch (error) {
            window.location.href = '/login';
        }
    }

    // 显示修改密码弹窗
    function showChangePasswordModal() {
        document.getElementById('changePasswordModal').classList.remove('hidden');
    }

    function closeChangePasswordModal() {
        document.getElementById('changePasswordModal').classList.add('hidden');
        document.getElementById('changePasswordForm').reset();
    }

    // 修改密码表单提交
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword !== confirmPassword) {
            showToast('两次输入的密码不一致', 'error');
            return;
        }
        
        if (newPassword.length < 6 || newPassword.length > 18) {
            showToast('密码长度需在6-18位之间', 'error');
            return;
        }
        
        try {
            const response = await fetch('/api/users/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: newPassword })
            });
            
            if (response.ok) {
                closeChangePasswordModal();
                showToast('密码修改成功', 'success');
            } else {
                const data = await response.json();
                showToast(data.detail || '密码修改失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    });

    // 显示提示消息
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const content = document.getElementById('toastContent');
        
        const colors = {
            success: 'bg-green-50 text-green-800 border border-green-200',
            error: 'bg-red-50 text-red-800 border border-red-200',
            info: 'bg-blue-50 text-blue-800 border border-blue-200'
        };
        
        const icons = {
            success: '<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
            error: '<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
            info: '<svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        };
        
        content.className = `rounded-lg shadow-lg p-4 flex items-center gap-3 ${colors[type]}`;
        content.innerHTML = `${icons[type]}<span class="font-medium">${message}</span>`;
        
        toast.classList.remove('hidden');
        
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }

    // 退出登录
    async function logout() {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.href = '/login';
    }

    // HTML转义
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 启动
    init();
</script>
