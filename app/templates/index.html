{% extends "base.html" %}

{% block title %}AxHost - 原型管理{% endblock %}

{% block extra_css %}
<style>
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    
    /* 文件上传美化 */
    .file-upload-zone {
        border: 2px dashed #d1d5db;
        transition: all 0.3s ease;
    }
    .file-upload-zone:hover, .file-upload-zone.dragover {
        border-color: #FF6600;
        background-color: #FFF0E6;
    }
    .file-upload-zone.has-file {
        border-color: #10b981;
        background-color: #ecfdf5;
    }
    
    /* 表格样式 */
    .table-row:hover {
        background-color: #f9fafb;
    }
    
    /* 视图切换按钮 */
    .view-btn {
        transition: all 0.2s ease;
    }
    .view-btn.active {
        background-color: #FF6600;
        color: white;
    }
    
    /* 项目类型切换按钮 */
    .project-type-btn {
        transition: all 0.2s ease;
    }
    .project-type-btn.active {
        background-color: #FF6600;
        color: white;
    }
</style>
{% endblock %}

{% block nav_extra %}
<a href="/admin" id="adminLink" class="hidden h-9 px-3 bg-white border border-gray-300 rounded-lg text-gray-600 hover:text-orange-600 hover:border-orange-300 transition-all text-sm font-medium flex items-center gap-1.5">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
    </svg>
    管理后台
</a>
{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- 筛选表单 -->
    <div class="mb-6">
        <!-- 第一行：筛选条件 -->
        <div class="flex items-center gap-3">
            <!-- 左侧：筛选条件组 -->
            <div class="flex flex-wrap items-center gap-3 flex-1">
                <!-- 搜索项目 - 固定宽度 -->
                <div class="relative w-[280px]">
                    <input type="text" id="searchInput" placeholder="搜索项目..."
                        class="w-full h-10 px-4 pl-10 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all text-sm"
                        onkeyup="if(event.key==='Enter')loadProjects()">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                
                <!-- 视图切换 -->
                <div class="flex items-center bg-white rounded-lg border border-gray-300 p-1 h-10">
                    <button id="cardViewBtn" onclick="switchView('card')" class="view-btn active px-3 h-8 rounded-md text-sm font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                        </svg>
                        卡片
                    </button>
                    <button id="listViewBtn" onclick="switchView('list')" class="view-btn px-3 h-8 rounded-md text-sm font-medium text-gray-600 flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                        列表
                    </button>
                </div>
                
                <!-- 项目类型切换 -->
                <div class="flex items-center bg-white rounded-lg border border-gray-300 p-1 h-10">
                    <button id="myProjectBtn" onclick="switchProjectType('my')" class="project-type-btn active px-3 h-8 rounded-md text-sm font-medium">
                        我的项目
                    </button>
                    <button id="collaborateBtn" onclick="switchProjectType('collaborate')" class="project-type-btn px-3 h-8 rounded-md text-sm font-medium text-gray-600">
                        协作项目
                    </button>
                </div>
                
                <!-- 作者筛选 - 占位布局，避免跳动 -->
                <div id="authorFilterContainer" class="w-[120px] opacity-0 pointer-events-none transition-opacity duration-200">
                    <select id="authorFilter" onchange="loadProjects()" class="h-10 px-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm bg-white w-full">
                        <option value="">全部作者</option>
                    </select>
                </div>
            </div>
            
            <!-- 右侧：搜索和重置按钮 -->
            <div class="flex items-center gap-3">
                <!-- 搜索按钮 -->
                <button onclick="loadProjects()" class="h-10 px-4 bg-gradient-to-r from-orange-600 to-orange-500 text-white font-medium rounded-lg hover:from-orange-700 hover:to-orange-600 transition-all text-sm flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    搜索
                </button>
                
                <!-- 重置按钮 -->
                <button onclick="resetFilters()" class="h-10 px-4 border border-gray-300 text-gray-600 font-medium rounded-lg hover:bg-gray-50 transition-all text-sm flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    重置
                </button>
            </div>
        </div>
    </div>

    <!-- 第二行：新增项目 + 分页 -->
    <div class="flex items-center justify-between mb-6">
        <!-- 左侧：新增项目 -->
        <button id="uploadBtn" onclick="showUploadModal()" class="hidden h-10 px-4 bg-gradient-to-r from-orange-600 to-orange-500 text-white font-medium rounded-lg hover:from-orange-700 hover:to-orange-600 transition-all flex items-center gap-2 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            新增项目
        </button>
        
        <!-- 右侧：分页 -->
        <div id="pagination" class="flex items-center space-x-2">
            <!-- 动态加载 -->
        </div>
    </div>

    <!-- 项目列表 - 卡片视图 -->
    <div id="cardView" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- 动态加载 -->
    </div>

    <!-- 项目列表 - 列表视图 -->
    <div id="listView" class="hidden bg-white rounded-xl shadow-sm border border-gray-200">
        <!-- 表头 -->
        <div class="bg-gray-50 border-b border-gray-200 grid grid-cols-12 gap-4 px-6 py-4">
            <div class="col-span-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">项目名称</div>
            <div class="col-span-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">作者</div>
            <div class="col-span-1 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">状态</div>
            <div class="col-span-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">更新时间</div>
            <div class="col-span-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">备注</div>
            <div class="col-span-2 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">操作</div>
        </div>
        <!-- 列表内容 -->
        <div id="listViewBody" class="divide-y divide-gray-200">
            <!-- 动态加载 -->
        </div>
    </div>
</main>

<!-- 上传弹窗 -->
<div id="uploadModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4 modal-enter">
        <h3 class="text-xl font-bold mb-6">新增项目</h3>
        <form id="uploadForm" class="space-y-6">
            <!-- 项目名称 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">项目名称</label>
                <input type="text" id="projectName" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all">
            </div>
            
            <!-- 原型文件 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">原型文件</label>
                <div id="uploadZone" class="file-upload-zone rounded-lg p-6 text-center cursor-pointer relative">
                    <input type="file" id="projectFile" accept=".zip,.html" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    <div id="uploadPlaceholder">
                        <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-sm text-gray-600">点击或拖拽文件到此处上传</p>
                        <p class="text-xs text-gray-400 mt-1">请将输出的原型文件打包为 zip 文件上传</p>
                    </div>
                    <div id="uploadFileInfo" class="hidden">
                        <svg class="w-10 h-10 text-green-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p id="uploadFileName" class="text-sm font-medium text-gray-900"></p>
                        <p class="text-xs text-gray-500 mt-1">点击更换文件</p>
                    </div>
                </div>
            </div>
            
            <!-- 密码访问 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">密码访问</label>
                <div class="min-h-[44px] flex items-center">
                    <div class="flex items-center gap-3 w-full">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="usePassword" class="w-4 h-4 text-orange-600 rounded border-gray-300 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-600">开启</span>
                        </label>
                        <div id="passwordSection" class="hidden flex-1 flex gap-2">
                            <input type="text" id="viewPassword" placeholder="设置访问密码" class="flex-1 px-3 py-2 text-sm rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <button type="button" onclick="generatePassword()" class="px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium whitespace-nowrap">随机生成</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 备注 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                <textarea id="remark" rows="3" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all resize-none" placeholder="请输入项目备注（可选）"></textarea>
            </div>
            
            <!-- 按钮 -->
            <div class="flex gap-3 pt-2">
                <button type="button" onclick="closeUploadModal()" class="flex-1 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">取消</button>
                <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-lg hover:from-orange-700 hover:to-orange-600 transition-colors font-medium">上传</button>
            </div>
        </form>
    </div>
</div>

<!-- 更新原型模态框 -->
<div id="updateModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4 modal-enter">
        <h3 class="text-xl font-bold mb-4">更新原型</h3>
        <form id="updateForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">项目名称</label>
                <input type="text" id="updateProjectName" readonly class="w-full px-4 py-2 rounded-lg border border-gray-200 bg-gray-50 text-gray-500 cursor-not-allowed">
            </div>
            <input type="hidden" id="updateProjectId">
            
            <!-- 美化的文件上传组件 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">新原型文件 <span class="text-red-500">*</span></label>
                <div id="updateUploadZone" class="file-upload-zone rounded-lg p-6 text-center cursor-pointer relative">
                    <input type="file" id="updateProjectFile" accept=".zip,.html" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    <div id="updateUploadPlaceholder">
                        <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-sm text-gray-600">点击或拖拽文件到此处上传</p>
                        <p class="text-xs text-gray-400 mt-1">请将输出的原型文件打包为 zip 文件上传（将覆盖原有文件）</p>
                    </div>
                    <div id="updateUploadFileInfo" class="hidden">
                        <svg class="w-10 h-10 text-green-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p id="updateUploadFileName" class="text-sm font-medium text-gray-900"></p>
                        <p class="text-xs text-gray-500 mt-1">点击更换文件</p>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeUpdateModal()" class="flex-1 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">取消</button>
                <button type="submit" class="flex-1 py-2.5 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-lg hover:from-orange-700 hover:to-orange-600 transition-colors font-medium">确认更新</button>
            </div>
        </form>
    </div>
</div>

<!-- 编辑弹窗 -->
<div id="editModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4 modal-enter">
        <h3 class="text-xl font-bold mb-6">编辑项目</h3>
        <form id="editForm" class="space-y-6">
            <input type="hidden" id="editProjectId">
            <!-- 项目名称 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">项目名称</label>
                <input type="text" id="editProjectName" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all">
            </div>
            
            <!-- 密码访问 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">密码访问</label>
                <div class="min-h-[44px] flex items-center">
                    <div class="flex items-center gap-3 w-full">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="editUsePassword" class="w-4 h-4 text-orange-600 rounded border-gray-300 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-600">开启</span>
                        </label>
                        <div id="editPasswordSection" class="hidden flex-1 flex gap-2">
                            <input type="text" id="editViewPassword" placeholder="设置访问密码" class="flex-1 px-3 py-2 text-sm rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <button type="button" onclick="generateEditPassword()" class="px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium whitespace-nowrap">随机生成</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 备注 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                <textarea id="editRemark" rows="3" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all resize-none" placeholder="请输入项目备注（可选）"></textarea>
            </div>
            
            <!-- 按钮 -->
            <div class="flex gap-3 pt-2">
                <button type="button" onclick="closeEditModal()" class="flex-1 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">取消</button>
                <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-lg hover:from-orange-700 hover:to-orange-600 transition-colors font-medium">保存修改</button>
            </div>
        </form>
    </div>
</div>

<!-- 备注详情弹窗 -->
<div id="remarkModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-lg mx-4 modal-enter">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold">项目备注</h3>
            <button onclick="closeRemarkModal()" class="p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="bg-gray-50 rounded-lg p-4 max-h-[300px] overflow-y-auto">
            <p id="remarkContent" class="text-sm text-gray-700 whitespace-pre-wrap"></p>
        </div>
    </div>
</div>

<!-- 删除确认弹窗 -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 modal-enter">
        <div class="text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold mb-2">确认删除</h3>
            <p class="text-gray-500 mb-6">确定要删除原型 <span id="deleteProjectName" class="font-medium text-gray-900"></span> 吗？此操作不可恢复。</p>
            <input type="hidden" id="deleteProjectId">
            <div class="flex gap-3">
                <button type="button" onclick="closeDeleteModal()" class="flex-1 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">取消</button>
                <button type="button" onclick="confirmDelete()" class="flex-1 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">确认删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 更改作者模态框 -->
<div id="changeAuthorModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4 modal-enter">
        <h3 class="text-xl font-bold mb-4">更改作者</h3>
        <form id="changeAuthorForm" class="space-y-4">
            <input type="hidden" id="changeAuthorProjectId">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">项目名称</label>
                <input type="text" id="changeAuthorProjectName" readonly class="w-full px-4 py-2 rounded-lg border border-gray-200 bg-gray-50 text-gray-500 cursor-not-allowed">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">选择新作者</label>
                <select id="newAuthorSelect" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white">
                    <option value="">请选择新作者</option>
                    <!-- 动态加载 -->
                </select>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeChangeAuthorModal()" class="flex-1 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">取消</button>
                <button type="submit" class="flex-1 py-2.5 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-lg hover:from-orange-700 hover:to-orange-600 transition-colors font-medium">确认更改</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
// 项目数据相关
let currentPage = 1;
let currentView = localStorage.getItem('projectView') || 'card';
let currentProjectType = 'my'; // my: 我的项目, collaborate: 协作项目
let projectsData = [];
let activeDropdown = null;

// 初始化：加载保存的视图配置并应用
document.addEventListener('DOMContentLoaded', () => {
    // 应用保存的视图配置
    if (currentView === 'list') {
        document.getElementById('cardViewBtn').classList.remove('active');
        document.getElementById('listViewBtn').classList.add('active');
        document.getElementById('cardView').classList.add('hidden');
        document.getElementById('listView').classList.remove('hidden');
    }
    // 加载作者列表（用于协作项目筛选）
    loadAuthors();
});

// 加载作者列表（排除当前用户）
async function loadAuthors() {
    try {
        const response = await fetch('/api/users/options');
        const users = await response.json();
        const select = document.getElementById('authorFilter');
        // 保留"全部作者"选项，添加其他作者（排除当前用户）
        const currentHtml = '<option value="">全部作者</option>';
        const options = users
            .filter(u => u.id !== currentUser.id)
            .map(u => `<option value="${u.id}">${escapeHtml(u.name)}</option>`)
            .join('');
        select.innerHTML = currentHtml + options;
    } catch (error) {
        console.error('加载作者列表失败:', error);
    }
}

// 切换项目类型
function switchProjectType(type) {
    currentProjectType = type;
    
    // 更新按钮样式
    const myBtn = document.getElementById('myProjectBtn');
    const collabBtn = document.getElementById('collaborateBtn');
    const authorFilter = document.getElementById('authorFilterContainer');
    
    if (type === 'my') {
        myBtn.classList.add('active');
        myBtn.classList.remove('text-gray-600');
        collabBtn.classList.remove('active');
        collabBtn.classList.add('text-gray-600');
        // 隐藏作者筛选 - 使用 opacity 和 pointer-events 避免布局跳动
        authorFilter.classList.add('opacity-0', 'pointer-events-none');
        authorFilter.classList.remove('opacity-100');
        // 清空作者筛选
        document.getElementById('authorFilter').value = '';
    } else {
        collabBtn.classList.add('active');
        collabBtn.classList.remove('text-gray-600');
        myBtn.classList.remove('active');
        myBtn.classList.add('text-gray-600');
        // 显示作者筛选
        authorFilter.classList.remove('opacity-0', 'pointer-events-none');
        authorFilter.classList.add('opacity-100');
    }
    
    // 切换后立即搜索
    loadProjects(1);
}

// 重置筛选条件
function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('authorFilter').value = '';
    
    // 重置为我的项目
    if (currentProjectType !== 'my') {
        switchProjectType('my');
    } else {
        loadProjects(1);
    }
}

// 加载项目列表
async function loadProjects(page = 1) {
    currentPage = page;
    const search = document.getElementById('searchInput').value;
    const authorId = document.getElementById('authorFilter').value;
    
    // 构建查询参数
    let url = `/api/projects?page=${page}&per_page=12&search=${encodeURIComponent(search)}&project_type=${currentProjectType}`;
    if (authorId && currentProjectType === 'collaborate') {
        url += `&author_id=${authorId}`;
    }
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        projectsData = data.items;
        
        if (currentView === 'card') {
            renderCardView(data.items);
        } else {
            renderListView(data.items);
        }
        
        // 分页
        const totalPages = Math.ceil(data.total / data.per_page);
        const pageEl = document.getElementById('pagination');
        let pageHtml = '';
        for (let i = 1; i <= totalPages; i++) {
            pageHtml += `<button onclick="loadProjects(${i})" class="px-3 py-1 rounded ${i === page ? 'bg-orange-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}">${i}</button>`;
        }
        pageEl.innerHTML = pageHtml;
        
    } catch (error) {
        console.error('加载失败:', error);
        showToast('加载失败', 'error');
    }
}

// 渲染卡片视图
function renderCardView(projects) {
    const listEl = document.getElementById('cardView');
    if (projects.length === 0) {
        listEl.innerHTML = '<div class="col-span-full text-center py-12 text-gray-400">暂无原型项目</div>';
        return;
    }
    
    listEl.innerHTML = projects.map(project => {
        const canManage = currentUser && (currentUser.role === 'admin' || project.author_id === currentUser.id);
        const isAdmin = currentUser && currentUser.role === 'admin';
        const projectUrl = `${window.location.origin}/projects/${project.object_id}/`;
        const hasRemark = project.remark && project.remark.trim();
        const shortRemark = hasRemark ? project.remark.replace(/\\n/g, ' ').substring(0, 30) : '';
        const needMore = hasRemark && project.remark.length > 30;
        
        return `
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 card-hover transition-all relative group flex flex-col">
                <!-- 第一行：标签 + 项目标题 + 作者 + 更多按钮 -->
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                        ${project.is_public ? 
                            '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full flex-shrink-0">公开</span>' :
                            '<span class="px-2 py-0.5 bg-orange-100 text-orange-700 text-xs rounded-full flex-shrink-0">私密</span>'
                        }
                        <h3 class="font-semibold text-gray-900 truncate cursor-pointer hover:text-orange-600" onclick="viewProject('${project.object_id}')">${escapeHtml(project.name)}</h3>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                        <div class="flex items-center gap-1 text-sm text-gray-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span class="truncate max-w-[80px]">${escapeHtml(project.author_name)}</span>
                        </div>
                        <!-- 更多按钮 -->
                        <div class="relative">
                            <button onclick="toggleDropdown(event, '${project.object_id}')" class="p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
                                </svg>
                            </button>
                            <div id="dropdown-${project.object_id}" class="dropdown-menu absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10">
                                <button onclick="copyProjectLink('${projectUrl}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    复制链接
                                </button>
                                ${canManage ? `
                                <button onclick="showUpdateModal('${project.object_id}', '${escapeHtml(project.name)}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                    </svg>
                                    更新原型
                                </button>
                                <button onclick="showEditModal('${project.object_id}', '${escapeHtml(project.name)}', ${project.is_public}, '${project.view_password || ''}', '${escapeHtml(project.remark || '')}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    修改信息
                                </button>
                                <button onclick="showToast('编辑标签功能即将上线', 'info')" class="w-full px-4 py-2 text-left text-sm text-gray-400 cursor-not-allowed flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                    </svg>
                                    编辑标签
                                </button>
                                <button onclick="showDeleteModal('${project.object_id}', '${escapeHtml(project.name)}')" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    删除原型
                                </button>
                                ` : ''}
                                ${isAdmin ? `
                                <button onclick="showChangeAuthorModal('${project.object_id}', '${escapeHtml(project.name)}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    更改作者
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 第二行：标签列表 + 最后更新时间 -->
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-gray-300">标签功能即将上线</span>
                    <span class="text-xs text-gray-400">${project.updated_at}</span>
                </div>
                
                <!-- 分割线 -->
                <div class="border-t border-gray-100 my-2"></div>
                
                <!-- 备注 -->
                <div class="text-sm">
                    ${hasRemark ? `
                        <span class="text-gray-600 line-clamp-1">${escapeHtml(shortRemark)}${needMore ? '...' : ''}</span>
                        ${needMore ? `<button onclick="showRemarkModal('${escapeHtml(project.remark)}')" class="text-orange-600 hover:text-orange-700 text-xs mt-1">更多</button>` : ''}
                    ` : '<span class="text-gray-400">无备注</span>'}
                </div>
            </div>
        `;
    }).join('');
}

// 显示备注详情弹窗
function showRemarkModal(remark) {
    document.getElementById('remarkContent').textContent = remark;
    document.getElementById('remarkModal').classList.remove('hidden');
}

function closeRemarkModal() {
    document.getElementById('remarkModal').classList.add('hidden');
}

// 渲染列表视图
function renderListView(projects) {
    const tbody = document.getElementById('listViewBody');
    if (projects.length === 0) {
        tbody.innerHTML = '<div class="px-6 py-12 text-center text-gray-400">暂无原型项目</div>';
        return;
    }
    
    tbody.innerHTML = projects.map(project => {
        const canManage = currentUser && (currentUser.role === 'admin' || project.author_id === currentUser.id);
        const isAdmin = currentUser && currentUser.role === 'admin';
        const projectUrl = `${window.location.origin}/projects/${project.object_id}/`;
        const hasRemark = project.remark && project.remark.trim();
        const shortRemark = hasRemark ? project.remark.replace(/\\n/g, ' ').substring(0, 20) : '';
        const needMore = hasRemark && project.remark.length > 20;
        
        return `
            <div class="grid grid-cols-12 gap-4 px-6 py-4 items-center hover:bg-gray-50 transition-colors">
                <div class="col-span-2">
                    <div class="font-medium text-gray-900 cursor-pointer hover:text-orange-600 truncate" onclick="viewProject('${project.object_id}')">${escapeHtml(project.name)}</div>
                </div>
                <div class="col-span-2 text-sm text-gray-500 truncate">${escapeHtml(project.author_name)}</div>
                <div class="col-span-1">
                    ${project.is_public ? 
                        '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">公开</span>' :
                        '<span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full">私密</span>'
                    }
                </div>
                <div class="col-span-2 text-sm text-gray-500">${project.updated_at}</div>
                <div class="col-span-3 text-sm">
                    ${hasRemark ? `
                        <span class="text-gray-600 truncate inline-block max-w-full">${escapeHtml(shortRemark)}${needMore ? '...' : ''}</span>
                        ${needMore ? `<button onclick="showRemarkModal('${escapeHtml(project.remark)}')" class="text-orange-600 hover:text-orange-700 text-xs ml-1">更多</button>` : ''}
                    ` : '<span class="text-gray-400">无备注</span>'}
                </div>
                <div class="col-span-2 text-right">
                    <div class="relative inline-block">
                        <button onclick="toggleDropdown(event, 'list-${project.object_id}')" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                            </svg>
                        </button>
                        <div id="dropdown-list-${project.object_id}" class="dropdown-menu absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
                            <button onclick="copyProjectLink('${projectUrl}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                复制链接
                            </button>
                            ${canManage ? `
                            <button onclick="showUpdateModal('${project.object_id}', '${escapeHtml(project.name)}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                </svg>
                                更新原型
                            </button>
                            <button onclick="showEditModal('${project.object_id}', '${escapeHtml(project.name)}', ${project.is_public}, '${project.view_password || ''}', '${escapeHtml(project.remark || '')}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                修改信息
                            </button>
                            <button onclick="showToast('编辑标签功能即将上线', 'info')" class="w-full px-4 py-2 text-left text-sm text-gray-400 cursor-not-allowed flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                                编辑标签
                            </button>
                            <button onclick="showDeleteModal('${project.object_id}', '${escapeHtml(project.name)}')" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                删除原型
                            </button>
                            ` : ''}
                            ${isAdmin ? `
                            <button onclick="showChangeAuthorModal('${project.object_id}', '${escapeHtml(project.name)}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                更改作者
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// 切换视图
function switchView(view) {
    currentView = view;
    // 保存到 localStorage
    localStorage.setItem('projectView', view);
    
    const cardBtn = document.getElementById('cardViewBtn');
    const listBtn = document.getElementById('listViewBtn');
    const cardView = document.getElementById('cardView');
    const listView = document.getElementById('listView');
    
    if (view === 'card') {
        cardBtn.classList.add('active');
        listBtn.classList.remove('active');
        cardView.classList.remove('hidden');
        listView.classList.add('hidden');
        renderCardView(projectsData);
    } else {
        listBtn.classList.add('active');
        cardBtn.classList.remove('active');
        listView.classList.remove('hidden');
        cardView.classList.add('hidden');
        renderListView(projectsData);
    }
}

// 切换下拉菜单
function toggleDropdown(event, projectId) {
    event.stopPropagation();
    
    // 关闭之前打开的下拉菜单
    if (activeDropdown && activeDropdown !== `dropdown-${projectId}`) {
        const prevDropdown = document.getElementById(activeDropdown);
        if (prevDropdown) prevDropdown.classList.remove('show');
    }
    
    const dropdown = document.getElementById(`dropdown-${projectId}`);
    if (dropdown) {
        dropdown.classList.toggle('show');
        activeDropdown = dropdown.classList.contains('show') ? `dropdown-${projectId}` : null;
    }
}

// 点击其他地方关闭下拉菜单
document.addEventListener('click', () => {
    if (activeDropdown) {
        const dropdown = document.getElementById(activeDropdown);
        if (dropdown) dropdown.classList.remove('show');
        activeDropdown = null;
    }
});

// 设置文件上传拖拽
function setupFileUpload() {
    const zone = document.getElementById('uploadZone');
    const input = document.getElementById('projectFile');
    
    zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
    });
    
    zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
    });
    
    zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            input.files = files;
            updateFileDisplay(files[0], 'upload');
        }
    });
    
    input.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            updateFileDisplay(e.target.files[0], 'upload');
        }
    });
}

function setupUpdateFileUpload() {
    const zone = document.getElementById('updateUploadZone');
    const input = document.getElementById('updateProjectFile');
    
    zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
    });
    
    zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
    });
    
    zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            input.files = files;
            updateFileDisplay(files[0], 'update');
        }
    });
    
    input.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            updateFileDisplay(e.target.files[0], 'update');
        }
    });
}

function updateFileDisplay(file, type) {
    const zone = document.getElementById(type === 'upload' ? 'uploadZone' : 'updateUploadZone');
    const placeholder = document.getElementById(type === 'upload' ? 'uploadPlaceholder' : 'updateUploadPlaceholder');
    const fileInfo = document.getElementById(type === 'upload' ? 'uploadFileInfo' : 'updateUploadFileInfo');
    const fileName = document.getElementById(type === 'upload' ? 'uploadFileName' : 'updateUploadFileName');
    
    zone.classList.add('has-file');
    placeholder.classList.add('hidden');
    fileInfo.classList.remove('hidden');
    fileName.textContent = file.name;
}

// 显示上传弹窗
function showUploadModal() {
    document.getElementById('uploadModal').classList.remove('hidden');
}

function closeUploadModal() {
    document.getElementById('uploadModal').classList.add('hidden');
    document.getElementById('uploadForm').reset();
    resetFileDisplay('upload');
}

function resetFileDisplay(type) {
    const zone = document.getElementById(type === 'upload' ? 'uploadZone' : 'updateUploadZone');
    const placeholder = document.getElementById(type === 'upload' ? 'uploadPlaceholder' : 'updateUploadPlaceholder');
    const fileInfo = document.getElementById(type === 'upload' ? 'uploadFileInfo' : 'updateUploadFileInfo');
    
    zone.classList.remove('has-file');
    placeholder.classList.remove('hidden');
    fileInfo.classList.add('hidden');
}

// 显示更新原型弹窗
function showUpdateModal(objectId, projectName) {
    document.getElementById('updateProjectId').value = objectId;
    document.getElementById('updateProjectName').value = projectName;
    document.getElementById('updateModal').classList.remove('hidden');
}

function closeUpdateModal() {
    document.getElementById('updateModal').classList.add('hidden');
    document.getElementById('updateForm').reset();
    resetFileDisplay('update');
}

// 显示编辑弹窗
function showEditModal(objectId, projectName, isPublic, viewPassword, remark) {
    document.getElementById('editProjectId').value = objectId;
    document.getElementById('editProjectName').value = projectName;
    // 密码访问：非公开即使用密码
    const usePassword = !isPublic;
    document.getElementById('editUsePassword').checked = usePassword;
    document.getElementById('editViewPassword').value = viewPassword || '';
    document.getElementById('editRemark').value = remark || '';
    
    if (usePassword) {
        document.getElementById('editPasswordSection').classList.remove('hidden');
    } else {
        document.getElementById('editPasswordSection').classList.add('hidden');
    }
    
    document.getElementById('editModal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    document.getElementById('editForm').reset();
}

// 显示删除确认弹窗
function showDeleteModal(objectId, projectName) {
    document.getElementById('deleteProjectId').value = objectId;
    document.getElementById('deleteProjectName').textContent = projectName;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
}

// 显示更改作者弹窗
async function showChangeAuthorModal(objectId, projectName) {
    document.getElementById('changeAuthorProjectId').value = objectId;
    document.getElementById('changeAuthorProjectName').value = projectName;
    
    // 加载用户列表
    try {
        const response = await fetch('/api/users/options');
        const users = await response.json();
        const select = document.getElementById('newAuthorSelect');
        select.innerHTML = '<option value="">请选择新作者</option>' + 
            users.map(u => `<option value="${u.id}">${escapeHtml(u.name)} (${u.employee_id})</option>`).join('');
    } catch (error) {
        showToast('加载用户列表失败', 'error');
    }
    
    document.getElementById('changeAuthorModal').classList.remove('hidden');
}

function closeChangeAuthorModal() {
    document.getElementById('changeAuthorModal').classList.add('hidden');
    document.getElementById('changeAuthorForm').reset();
}

// 生成随机密码（6位数字+字母）
function generatePassword() {
    const chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let password = '';
    for (let i = 0; i < 6; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('viewPassword').value = password;
}

function generateEditPassword() {
    const chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let password = '';
    for (let i = 0; i < 6; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('editViewPassword').value = password;
}

// 复制项目链接
function copyProjectLink(url) {
    navigator.clipboard.writeText(url).then(() => {
        showToast('链接已复制到剪贴板', 'success');
    }).catch(() => {
        showToast('复制失败', 'error');
    });
}

// 查看项目
function viewProject(objectId) {
    window.open(`/projects/${objectId}/`, '_blank');
}

// 事件监听 - 密码访问
document.getElementById('usePassword').addEventListener('change', (e) => {
    document.getElementById('passwordSection').classList.toggle('hidden', !e.target.checked);
});

document.getElementById('editUsePassword').addEventListener('change', (e) => {
    document.getElementById('editPasswordSection').classList.toggle('hidden', !e.target.checked);
});

// 上传表单提交
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const usePassword = document.getElementById('usePassword').checked;
    const formData = new FormData();
    formData.append('file', document.getElementById('projectFile').files[0]);
    formData.append('name', document.getElementById('projectName').value);
    formData.append('is_public', !usePassword); // 使用密码则不公开
    formData.append('remark', document.getElementById('remark').value);
    
    if (usePassword) {
        formData.append('view_password', document.getElementById('viewPassword').value);
    }
    
    try {
        const response = await fetch('/api/projects/upload', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            closeUploadModal();
            loadProjects();
            showToast('上传成功', 'success');
        } else {
            const data = await response.json();
            showToast(data.detail || '上传失败', 'error');
        }
    } catch (error) {
        showToast('网络错误', 'error');
    }
});

// 更新原型表单提交
document.getElementById('updateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const objectId = document.getElementById('updateProjectId').value;
    const formData = new FormData();
    formData.append('file', document.getElementById('updateProjectFile').files[0]);
    
    try {
        const response = await fetch(`/api/projects/${objectId}/update-file`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            closeUpdateModal();
            loadProjects();
            showToast('更新成功', 'success');
        } else {
            const data = await response.json();
            showToast(data.detail || '更新失败', 'error');
        }
    } catch (error) {
        showToast('网络错误', 'error');
    }
});

// 修改信息表单提交
document.getElementById('editForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const objectId = document.getElementById('editProjectId').value;
    const usePassword = document.getElementById('editUsePassword').checked;
    const data = {
        name: document.getElementById('editProjectName').value,
        is_public: !usePassword, // 使用密码则不公开
        remark: document.getElementById('editRemark').value
    };
    
    if (usePassword) {
        data.view_password = document.getElementById('editViewPassword').value;
    }
    
    try {
        const response = await fetch(`/api/projects/${objectId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            closeEditModal();
            loadProjects();
            showToast('修改成功', 'success');
        } else {
            const resData = await response.json();
            showToast(resData.detail || '修改失败', 'error');
        }
    } catch (error) {
        showToast('网络错误', 'error');
    }
});

// 确认删除
async function confirmDelete() {
    const objectId = document.getElementById('deleteProjectId').value;
    
    try {
        const response = await fetch(`/api/projects/${objectId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            closeDeleteModal();
            loadProjects();
            showToast('删除成功', 'success');
        } else {
            const data = await response.json();
            showToast(data.detail || '删除失败', 'error');
        }
    } catch (error) {
        showToast('网络错误', 'error');
    }
}

// 更改作者表单提交
document.getElementById('changeAuthorForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const objectId = document.getElementById('changeAuthorProjectId').value;
    const newAuthorId = document.getElementById('newAuthorSelect').value;
    
    try {
        const response = await fetch(`/api/projects/${objectId}/change-author`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ new_author_id: parseInt(newAuthorId) })
        });
        
        if (response.ok) {
            closeChangeAuthorModal();
            loadProjects();
            showToast('作者更改成功', 'success');
        } else {
            const data = await response.json();
            showToast(data.detail || '更改失败', 'error');
        }
    } catch (error) {
        showToast('网络错误', 'error');
    }
});

// 初始化
setupFileUpload();
setupUpdateFileUpload();
loadProjects();
{% endblock %}
