<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AxHost - 原型管理</title>
    <script src="/static/js/tailwindcss.js"></script>
    <link href="/static/css/inter-font.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .gradient-text { background: linear-gradient(135deg, #FF6600 0%, #FF8533 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* 下拉菜单动画 */
        .dropdown-menu {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }
        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        /* 文件上传美化 */
        .file-upload-zone {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .file-upload-zone:hover, .file-upload-zone.dragover {
            border-color: #FF6600;
            background-color: #FFF0E6;
        }
        .file-upload-zone.has-file {
            border-color: #10b981;
            background-color: #ecfdf5;
        }
        
        /* 表格样式 */
        .table-row:hover {
            background-color: #f9fafb;
        }
        
        /* 视图切换按钮 */
        .view-btn {
            transition: all 0.2s ease;
        }
        .view-btn.active {
            background-color: #FF6600;
            color: white;
        }
        
        /* 弹窗动画 */
        .modal-enter {
            animation: modalIn 0.3s ease;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                    </div>
                    <span class="text-xl font-bold gradient-text">AxHost</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userName" class="text-gray-600"></span>
                    <a href="/admin" id="adminLink" class="hidden text-gray-600 hover:text-orange-600 transition-colors">管理后台</a>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600 transition-colors">退出</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 搜索、视图切换和上传 -->
        <div class="mb-8 flex flex-col sm:flex-row gap-4">
            <div class="flex-1 relative">
                <input type="text" id="searchInput" placeholder="搜索原型..."
                    class="w-full h-12 px-4 pl-12 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                    onkeyup="if(event.key==='Enter')loadProjects()">
                <svg class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            
            <!-- 视图切换 -->
            <div class="flex items-center bg-white rounded-lg border border-gray-300 p-1 h-12">
                <button id="cardViewBtn" onclick="switchView('card')" class="view-btn active px-4 h-10 rounded-md text-sm font-medium flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                    </svg>
                    卡片
                </button>
                <button id="listViewBtn" onclick="switchView('list')" class="view-btn px-4 h-10 rounded-md text-sm font-medium text-gray-600 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                    列表
                </button>
            </div>
            
            <button id="uploadBtn" onclick="showUploadModal()" class="hidden h-12 px-6 bg-gradient-to-r from-orange-600 to-orange-500 text-white font-medium rounded-lg hover:from-orange-700 hover:to-orange-600 transition-all flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                新增项目
            </button>
        </div>

        <!-- 项目列表 - 卡片视图 -->
        <div id="cardView" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- 动态加载 -->
        </div>

        <!-- 项目列表 - 列表视图 -->
        <div id="listView" class="hidden bg-white rounded-xl shadow-sm border border-gray-200">
            <!-- 表头 -->
            <div class="bg-gray-50 border-b border-gray-200 grid grid-cols-12 gap-4 px-6 py-4">
                <div class="col-span-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">项目名称</div>
                <div class="col-span-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">作者</div>
                <div class="col-span-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">状态</div>
                <div class="col-span-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">更新时间</div>
                <div class="col-span-2 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">操作</div>
            </div>
            <!-- 列表内容 -->
            <div id="listViewBody" class="divide-y divide-gray-200">
                <!-- 动态加载 -->
            </div>
        </div>

        <!-- 分页 -->
        <div id="pagination" class="mt-8 flex justify-center space-x-2">
            <!-- 动态加载 -->
        </div>
    </main>

    <!-- 上传模态框 -->
    <div id="uploadModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4 modal-enter">
            <h3 class="text-xl font-bold mb-4">上传原型</h3>
            <form id="uploadForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">项目名称</label>
                    <input type="text" id="projectName" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>
                
                <!-- 美化的文件上传组件 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">原型文件</label>
                    <div id="uploadZone" class="file-upload-zone rounded-lg p-6 text-center cursor-pointer relative">
                        <input type="file" id="projectFile" accept=".zip,.html" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div id="uploadPlaceholder">
                            <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p class="text-sm text-gray-600">点击或拖拽文件到此处上传</p>
                            <p class="text-xs text-gray-400 mt-1">请将输出的原型文件打包为 zip 文件上传</p>
                        </div>
                        <div id="uploadFileInfo" class="hidden">
                            <svg class="w-10 h-10 text-green-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p id="uploadFileName" class="text-sm font-medium text-gray-900"></p>
                            <p class="text-xs text-gray-500 mt-1">点击更换文件</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="isPublic" checked class="w-4 h-4 text-orange-600 rounded border-gray-300 focus:ring-orange-500">
                        <span class="ml-2 text-sm text-gray-600">公开访问</span>
                    </label>
                </div>
                <div id="passwordSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">查看密码</label>
                    <div class="flex gap-2">
                        <input type="text" id="viewPassword" class="flex-1 px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <button type="button" onclick="generatePassword()" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium">随机生成</button>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeUploadModal()" class="flex-1 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">取消</button>
                    <button type="submit" class="flex-1 py-2.5 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-lg hover:from-orange-700 hover:to-orange-600 transition-colors font-medium">上传</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 更新原型模态框 -->
    <div id="updateModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4 modal-enter">
            <h3 class="text-xl font-bold mb-4">更新原型</h3>
            <form id="updateForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">项目名称</label>
                    <input type="text" id="updateProjectName" readonly class="w-full px-4 py-2 rounded-lg border border-gray-200 bg-gray-50 text-gray-500 cursor-not-allowed">
                </div>
                <input type="hidden" id="updateProjectId">
                
                <!-- 美化的文件上传组件 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">新原型文件 <span class="text-red-500">*</span></label>
                    <div id="updateUploadZone" class="file-upload-zone rounded-lg p-6 text-center cursor-pointer relative">
                        <input type="file" id="updateProjectFile" accept=".zip,.html" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div id="updateUploadPlaceholder">
                            <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p class="text-sm text-gray-600">点击或拖拽文件到此处上传</p>
                            <p class="text-xs text-gray-400 mt-1">请将输出的原型文件打包为 zip 文件上传（将覆盖原有文件）</p>
                        </div>
                        <div id="updateUploadFileInfo" class="hidden">
                            <svg class="w-10 h-10 text-green-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p id="updateUploadFileName" class="text-sm font-medium text-gray-900"></p>
                            <p class="text-xs text-gray-500 mt-1">点击更换文件</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeUpdateModal()" class="flex-1 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">取消</button>
                    <button type="submit" class="flex-1 py-2.5 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-lg hover:from-orange-700 hover:to-orange-600 transition-colors font-medium">确认更新</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 修改信息模态框 -->
    <div id="editModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4 modal-enter">
            <h3 class="text-xl font-bold mb-4">修改信息</h3>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editProjectId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">项目名称</label>
                    <input type="text" id="editProjectName" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>
                <div class="flex items-center gap-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="editIsPublic" class="w-4 h-4 text-orange-600 rounded border-gray-300 focus:ring-orange-500">
                        <span class="ml-2 text-sm text-gray-600">公开访问</span>
                    </label>
                </div>
                <div id="editPasswordSection">
                    <label class="block text-sm font-medium text-gray-700 mb-1">查看密码</label>
                    <div class="flex gap-2">
                        <input type="text" id="editViewPassword" class="flex-1 px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <button type="button" onclick="generateEditPassword()" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium">随机生成</button>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeEditModal()" class="flex-1 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">取消</button>
                    <button type="submit" class="flex-1 py-2.5 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-lg hover:from-orange-700 hover:to-orange-600 transition-colors font-medium">保存修改</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 modal-enter">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold mb-2">确认删除</h3>
                <p class="text-gray-500 mb-6">确定要删除原型 <span id="deleteProjectName" class="font-medium text-gray-900"></span> 吗？此操作不可恢复。</p>
                <input type="hidden" id="deleteProjectId">
                <div class="flex gap-3">
                    <button type="button" onclick="closeDeleteModal()" class="flex-1 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">取消</button>
                    <button type="button" onclick="confirmDelete()" class="flex-1 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 更改作者模态框 -->
    <div id="changeAuthorModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4 modal-enter">
            <h3 class="text-xl font-bold mb-4">更改作者</h3>
            <form id="changeAuthorForm" class="space-y-4">
                <input type="hidden" id="changeAuthorProjectId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">项目名称</label>
                    <input type="text" id="changeAuthorProjectName" readonly class="w-full px-4 py-2 rounded-lg border border-gray-200 bg-gray-50 text-gray-500 cursor-not-allowed">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">选择新作者</label>
                    <select id="newAuthorSelect" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white">
                        <option value="">请选择新作者</option>
                        <!-- 动态加载 -->
                    </select>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeChangeAuthorModal()" class="flex-1 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">取消</button>
                    <button type="submit" class="flex-1 py-2.5 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-lg hover:from-orange-700 hover:to-orange-600 transition-colors font-medium">确认更改</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 提示消息 -->
    <div id="toast" class="hidden fixed top-4 right-4 z-50 transform transition-all duration-300">
        <div id="toastContent" class="rounded-lg shadow-lg p-4 flex items-center gap-3">
            <!-- 动态内容 -->
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentPage = 1;
        let currentView = 'card'; // 'card' or 'list'
        let projectsData = [];
        let activeDropdown = null;

        // 初始化
        async function init() {
            try {
                const response = await fetch('/api/auth/me');
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }
                currentUser = await response.json();
                document.getElementById('userName').textContent = currentUser.name;
                
                // 显示上传按钮（管理员和产品经理）
                if (['admin', 'product_manager'].includes(currentUser.role)) {
                    document.getElementById('uploadBtn').classList.remove('hidden');
                }
                
                // 显示管理后台链接（管理员）
                if (currentUser.role === 'admin') {
                    document.getElementById('adminLink').classList.remove('hidden');
                }
                
                loadProjects();
                setupFileUpload();
                setupUpdateFileUpload();
                setupDropdownClose();
            } catch (error) {
                window.location.href = '/login';
            }
        }

        // 加载项目列表
        async function loadProjects(page = 1) {
            currentPage = page;
            const search = document.getElementById('searchInput').value;
            
            try {
                const response = await fetch(`/api/projects?page=${page}&per_page=12&search=${encodeURIComponent(search)}`);
                const data = await response.json();
                projectsData = data.items;
                
                if (currentView === 'card') {
                    renderCardView(data.items);
                } else {
                    renderListView(data.items);
                }
                
                // 分页
                const totalPages = Math.ceil(data.total / data.per_page);
                const pageEl = document.getElementById('pagination');
                let pageHtml = '';
                for (let i = 1; i <= totalPages; i++) {
                    pageHtml += `<button onclick="loadProjects(${i})" class="px-3 py-1 rounded ${i === page ? 'bg-orange-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}">${i}</button>`;
                }
                pageEl.innerHTML = pageHtml;
                
            } catch (error) {
                console.error('加载失败:', error);
                showToast('加载失败', 'error');
            }
        }

        // 格式化日期时间
        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // 渲染卡片视图
        function renderCardView(projects) {
            const listEl = document.getElementById('cardView');
            if (projects.length === 0) {
                listEl.innerHTML = '<div class="col-span-full text-center py-12 text-gray-400">暂无原型项目</div>';
                return;
            }
            
            listEl.innerHTML = projects.map(project => {
                const canManage = currentUser.role === 'admin' || project.author_id === currentUser.id;
                const isAdmin = currentUser.role === 'admin';
                const projectUrl = `${window.location.origin}/projects/${project.object_id}/`;
                
                return `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 card-hover transition-all relative group flex flex-col">
                        <!-- 第一行：项目名称 + 标签 + 更多按钮 -->
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-900 line-clamp-1 flex-1 mr-2 cursor-pointer hover:text-orange-600" onclick="viewProject('${project.object_id}')">${escapeHtml(project.name)}</h3>
                            <div class="flex items-center gap-2">
                                ${project.is_public ? 
                                    '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">公开</span>' :
                                    '<span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full">私密</span>'
                                }
                                <!-- 更多按钮 -->
                                <div class="relative">
                                    <button onclick="toggleDropdown(event, '${project.object_id}')" class="p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
                                        </svg>
                                    </button>
                                    <div id="dropdown-${project.object_id}" class="dropdown-menu absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10">
                                        <button onclick="copyProjectLink('${projectUrl}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                            复制链接
                                        </button>
                                        ${canManage ? `
                                        <button onclick="showUpdateModal('${project.object_id}', '${escapeHtml(project.name)}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                            </svg>
                                            更新原型
                                        </button>
                                        <button onclick="showEditModal('${project.object_id}', '${escapeHtml(project.name)}', ${project.is_public}, '${project.view_password || ''}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                            修改信息
                                        </button>
                                        <button onclick="showToast('编辑标签功能即将上线', 'info')" class="w-full px-4 py-2 text-left text-sm text-gray-400 cursor-not-allowed flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                            </svg>
                                            编辑标签
                                        </button>
                                        <button onclick="showDeleteModal('${project.object_id}', '${escapeHtml(project.name)}')" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                            删除原型
                                        </button>
                                        ` : ''}
                                        ${isAdmin ? `
                                        <button onclick="showChangeAuthorModal('${project.object_id}', '${escapeHtml(project.name)}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                            </svg>
                                            更改作者
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 第二行：作者 + 时间 -->
                        <div class="flex items-center justify-between mb-3">
                            <p class="text-sm text-gray-500">${escapeHtml(project.author_name)}</p>
                            <span class="text-xs text-gray-400">${formatDateTime(project.updated_at)}</span>
                        </div>
                        
                        <!-- 第三行：标签预留 -->
                        <div class="mt-auto">
                            <span class="text-xs text-gray-300">标签功能即将上线</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 渲染列表视图
        function renderListView(projects) {
            const tbody = document.getElementById('listViewBody');
            if (projects.length === 0) {
                tbody.innerHTML = '<div class="px-6 py-12 text-center text-gray-400">暂无原型项目</div>';
                return;
            }
            
            tbody.innerHTML = projects.map(project => {
                const canManage = currentUser.role === 'admin' || project.author_id === currentUser.id;
                const isAdmin = currentUser.role === 'admin';
                const projectUrl = `${window.location.origin}/projects/${project.object_id}/`;
                
                return `
                    <div class="grid grid-cols-12 gap-4 px-6 py-4 items-center hover:bg-gray-50 transition-colors">
                        <div class="col-span-3">
                            <div class="font-medium text-gray-900 cursor-pointer hover:text-orange-600 truncate" onclick="viewProject('${project.object_id}')">${escapeHtml(project.name)}</div>
                        </div>
                        <div class="col-span-2 text-sm text-gray-500 truncate">${escapeHtml(project.author_name)}</div>
                        <div class="col-span-2">
                            ${project.is_public ? 
                                '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">公开</span>' :
                                '<span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full">私密</span>'
                            }
                        </div>
                        <div class="col-span-3 text-sm text-gray-500">${formatDateTime(project.updated_at)}</div>
                        <div class="col-span-2 text-right">
                            <div class="relative inline-block">
                                <button onclick="toggleDropdown(event, 'list-${project.object_id}')" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                                    </svg>
                                </button>
                                <div id="dropdown-list-${project.object_id}" class="dropdown-menu absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
                                    <button onclick="copyProjectLink('${projectUrl}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                        复制链接
                                    </button>
                                    ${canManage ? `
                                    <button onclick="showUpdateModal('${project.object_id}', '${escapeHtml(project.name)}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                        </svg>
                                        更新原型
                                    </button>
                                    <button onclick="showEditModal('${project.object_id}', '${escapeHtml(project.name)}', ${project.is_public}, '${project.view_password || ''}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                        修改信息
                                    </button>
                                    <button onclick="showToast('编辑标签功能即将上线', 'info')" class="w-full px-4 py-2 text-left text-sm text-gray-400 cursor-not-allowed flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                        </svg>
                                        编辑标签
                                    </button>
                                    <button onclick="showDeleteModal('${project.object_id}', '${escapeHtml(project.name)}')" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        删除原型
                                    </button>
                                    ` : ''}
                                    ${isAdmin ? `
                                    <button onclick="showChangeAuthorModal('${project.object_id}', '${escapeHtml(project.name)}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        更改作者
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 切换视图
        function switchView(view) {
            currentView = view;
            const cardBtn = document.getElementById('cardViewBtn');
            const listBtn = document.getElementById('listViewBtn');
            const cardView = document.getElementById('cardView');
            const listView = document.getElementById('listView');
            
            if (view === 'card') {
                cardBtn.classList.add('active');
                listBtn.classList.remove('active');
                cardView.classList.remove('hidden');
                listView.classList.add('hidden');
                renderCardView(projectsData);
            } else {
                listBtn.classList.add('active');
                cardBtn.classList.remove('active');
                listView.classList.remove('hidden');
                cardView.classList.add('hidden');
                renderListView(projectsData);
            }
        }

        // 切换下拉菜单
        function toggleDropdown(event, projectId) {
            event.stopPropagation();
            
            // 关闭之前打开的下拉菜单
            if (activeDropdown && activeDropdown !== `dropdown-${projectId}`) {
                const prevDropdown = document.getElementById(activeDropdown);
                if (prevDropdown) prevDropdown.classList.remove('show');
            }
            
            const dropdown = document.getElementById(`dropdown-${projectId}`);
            if (dropdown) {
                dropdown.classList.toggle('show');
                activeDropdown = dropdown.classList.contains('show') ? `dropdown-${projectId}` : null;
            }
        }

        // 点击其他地方关闭下拉菜单
        function setupDropdownClose() {
            document.addEventListener('click', () => {
                if (activeDropdown) {
                    const dropdown = document.getElementById(activeDropdown);
                    if (dropdown) dropdown.classList.remove('show');
                    activeDropdown = null;
                }
            });
        }

        // 设置文件上传拖拽
        function setupFileUpload() {
            const zone = document.getElementById('uploadZone');
            const input = document.getElementById('projectFile');
            
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });
            
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    input.files = files;
                    updateFileDisplay(files[0], 'upload');
                }
            });
            
            input.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    updateFileDisplay(e.target.files[0], 'upload');
                }
            });
        }

        function setupUpdateFileUpload() {
            const zone = document.getElementById('updateUploadZone');
            const input = document.getElementById('updateProjectFile');
            
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });
            
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    input.files = files;
                    updateFileDisplay(files[0], 'update');
                }
            });
            
            input.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    updateFileDisplay(e.target.files[0], 'update');
                }
            });
        }

        function updateFileDisplay(file, type) {
            const zone = document.getElementById(type === 'upload' ? 'uploadZone' : 'updateUploadZone');
            const placeholder = document.getElementById(type === 'upload' ? 'uploadPlaceholder' : 'updateUploadPlaceholder');
            const fileInfo = document.getElementById(type === 'upload' ? 'uploadFileInfo' : 'updateUploadFileInfo');
            const fileName = document.getElementById(type === 'upload' ? 'uploadFileName' : 'updateUploadFileName');
            
            zone.classList.add('has-file');
            placeholder.classList.add('hidden');
            fileInfo.classList.remove('hidden');
            fileName.textContent = file.name;
        }

        // 显示上传弹窗
        function showUploadModal() {
            document.getElementById('uploadModal').classList.remove('hidden');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('uploadForm').reset();
            resetFileDisplay('upload');
        }

        function resetFileDisplay(type) {
            const zone = document.getElementById(type === 'upload' ? 'uploadZone' : 'updateUploadZone');
            const placeholder = document.getElementById(type === 'upload' ? 'uploadPlaceholder' : 'updateUploadPlaceholder');
            const fileInfo = document.getElementById(type === 'upload' ? 'uploadFileInfo' : 'updateUploadFileInfo');
            
            zone.classList.remove('has-file');
            placeholder.classList.remove('hidden');
            fileInfo.classList.add('hidden');
        }

        // 显示更新原型弹窗
        function showUpdateModal(objectId, projectName) {
            document.getElementById('updateProjectId').value = objectId;
            document.getElementById('updateProjectName').value = projectName;
            document.getElementById('updateModal').classList.remove('hidden');
        }

        function closeUpdateModal() {
            document.getElementById('updateModal').classList.add('hidden');
            document.getElementById('updateForm').reset();
            resetFileDisplay('update');
        }

        // 显示修改信息弹窗
        function showEditModal(objectId, projectName, isPublic, viewPassword) {
            document.getElementById('editProjectId').value = objectId;
            document.getElementById('editProjectName').value = projectName;
            document.getElementById('editIsPublic').checked = isPublic;
            document.getElementById('editViewPassword').value = viewPassword || '';
            
            if (isPublic) {
                document.getElementById('editPasswordSection').classList.add('hidden');
            } else {
                document.getElementById('editPasswordSection').classList.remove('hidden');
            }
            
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editForm').reset();
        }

        // 显示删除确认弹窗
        function showDeleteModal(objectId, projectName) {
            document.getElementById('deleteProjectId').value = objectId;
            document.getElementById('deleteProjectName').textContent = projectName;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
        }

        // 显示更改作者弹窗
        async function showChangeAuthorModal(objectId, projectName) {
            document.getElementById('changeAuthorProjectId').value = objectId;
            document.getElementById('changeAuthorProjectName').value = projectName;
            
            // 加载用户列表
            try {
                const response = await fetch('/api/users/options');
                const users = await response.json();
                const select = document.getElementById('newAuthorSelect');
                select.innerHTML = '<option value="">请选择新作者</option>' + 
                    users.map(u => `<option value="${u.id}">${escapeHtml(u.name)} (${u.employee_id})</option>`).join('');
            } catch (error) {
                showToast('加载用户列表失败', 'error');
            }
            
            document.getElementById('changeAuthorModal').classList.remove('hidden');
        }

        function closeChangeAuthorModal() {
            document.getElementById('changeAuthorModal').classList.add('hidden');
            document.getElementById('changeAuthorForm').reset();
        }

        // 生成随机密码（6位数字+字母）
        function generatePassword() {
            const chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let password = '';
            for (let i = 0; i < 6; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('viewPassword').value = password;
        }

        function generateEditPassword() {
            const chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let password = '';
            for (let i = 0; i < 6; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('editViewPassword').value = password;
        }

        // 复制项目链接
        function copyProjectLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast('链接已复制到剪贴板', 'success');
            }).catch(() => {
                showToast('复制失败', 'error');
            });
        }

        // 查看项目
        function viewProject(objectId) {
            window.open(`/projects/${objectId}/`, '_blank');
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const content = document.getElementById('toastContent');
            
            const colors = {
                success: 'bg-green-50 text-green-800 border border-green-200',
                error: 'bg-red-50 text-red-800 border border-red-200',
                info: 'bg-blue-50 text-blue-800 border border-blue-200'
            };
            
            const icons = {
                success: '<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
                error: '<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
                info: '<svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
            };
            
            content.className = `rounded-lg shadow-lg p-4 flex items-center gap-3 ${colors[type]}`;
            content.innerHTML = `${icons[type]}<span class="font-medium">${message}</span>`;
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 事件监听
        document.getElementById('isPublic').addEventListener('change', (e) => {
            document.getElementById('passwordSection').classList.toggle('hidden', e.target.checked);
        });

        document.getElementById('editIsPublic').addEventListener('change', (e) => {
            document.getElementById('editPasswordSection').classList.toggle('hidden', e.target.checked);
        });

        // 上传表单提交
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('file', document.getElementById('projectFile').files[0]);
            formData.append('name', document.getElementById('projectName').value);
            formData.append('is_public', document.getElementById('isPublic').checked);
            
            if (!document.getElementById('isPublic').checked) {
                formData.append('view_password', document.getElementById('viewPassword').value);
            }
            
            try {
                const response = await fetch('/api/projects/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    closeUploadModal();
                    loadProjects();
                    showToast('上传成功', 'success');
                } else {
                    const data = await response.json();
                    showToast(data.detail || '上传失败', 'error');
                }
            } catch (error) {
                showToast('网络错误', 'error');
            }
        });

        // 更新原型表单提交
        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const objectId = document.getElementById('updateProjectId').value;
            const formData = new FormData();
            formData.append('file', document.getElementById('updateProjectFile').files[0]);
            
            try {
                const response = await fetch(`/api/projects/${objectId}/update-file`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    closeUpdateModal();
                    loadProjects();
                    showToast('更新成功', 'success');
                } else {
                    const data = await response.json();
                    showToast(data.detail || '更新失败', 'error');
                }
            } catch (error) {
                showToast('网络错误', 'error');
            }
        });

        // 修改信息表单提交
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const objectId = document.getElementById('editProjectId').value;
            const data = {
                name: document.getElementById('editProjectName').value,
                is_public: document.getElementById('editIsPublic').checked
            };
            
            if (!data.is_public) {
                data.view_password = document.getElementById('editViewPassword').value;
            }
            
            try {
                const response = await fetch(`/api/projects/${objectId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeEditModal();
                    loadProjects();
                    showToast('修改成功', 'success');
                } else {
                    const resData = await response.json();
                    showToast(resData.detail || '修改失败', 'error');
                }
            } catch (error) {
                showToast('网络错误', 'error');
            }
        });

        // 确认删除
        async function confirmDelete() {
            const objectId = document.getElementById('deleteProjectId').value;
            
            try {
                const response = await fetch(`/api/projects/${objectId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    closeDeleteModal();
                    loadProjects();
                    showToast('删除成功', 'success');
                } else {
                    const data = await response.json();
                    showToast(data.detail || '删除失败', 'error');
                }
            } catch (error) {
                showToast('网络错误', 'error');
            }
        }

        // 更改作者表单提交
        document.getElementById('changeAuthorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const objectId = document.getElementById('changeAuthorProjectId').value;
            const newAuthorId = document.getElementById('newAuthorSelect').value;
            
            try {
                const response = await fetch(`/api/projects/${objectId}/change-author`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_author_id: parseInt(newAuthorId) })
                });
                
                if (response.ok) {
                    closeChangeAuthorModal();
                    loadProjects();
                    showToast('作者更改成功', 'success');
                } else {
                    const data = await response.json();
                    showToast(data.detail || '更改失败', 'error');
                }
            } catch (error) {
                showToast('网络错误', 'error');
            }
        });

        // 退出登录
        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        // 启动
        init();
    </script>
</body>
</html>
